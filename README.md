# DB ACCESS MODULE

Телеграм бот для получения данных из бд по запросу на естественном языке.

---

## Установка и запуск

### 1. Клонировать репозиторий

```bash
git clone git@github.com:whosermak/tg_bot.git
cd tg_bot
```

### 2. Создать файл окружения

```bash
cp .env_example .env
```

Заполнить значения в `.env`!!!!!

### 3. Запустить проект

```bash
docker compose up --build
```

После запуска:
- поднимается бд на postgres
- импортируются данные (дождитесь завершения пж)
- запускается тг бот

бот начинает принимать сообщения.

---

## Получение чувствительных данных

### Telegram Bot Token

1. Найти бота **BotFather** в тг
2. Выполнить команду `/newbot`
3. Получить токен и вставить его в `.env`

```
BOT_TOKEN=токен
```

---

### Ключ для GigaChat

1. Зарегистрироваться на https://developers.sber.ru/
2. Получить api ключ для gigachat
3. Добавить в `.env`

```
GIGACHAT_API_KEY=токен
```

---


## Архитектура проекта

Проект состоит из трёх сервисов:

- **db** — PostgreSQL
- **import** — импорт данных в бд
- **bot** — запуск бота

### обработка запроса:

1. Пользователь отправляет текстовое сообщение боту.
2. Запрос преобразуется в sql с помощью gigachat.
3. sql выполняется в postgres и результат отправляется пользователю.

---

## Подход к преобразованию текста в sql

1. В промпт передаётся описание таблиц
2. Пользовательский запрос добавляется в конце промта
3. Модель генерирует sql
5. Sql ыполняется в базе данных

### Пример промта (упрощенный)

```
Ты генерируешь SQL для PostgreSQL.

На входе — вопрос на русском языке в естественной форме.
На выходе — ОДИН корректный SQL-запрос, который возвращает РОВНО ОДНО ЧИСЛО.

Интерпретация естественного языка
Правила преобразования:
"Сколько всего видео" → COUNT(*) из videos
"Сколько видео" → COUNT(*) из videos
"Сколько видео у креатора с id X" → COUNT(*) из videos WHERE creator_id = 'X'
"Больше N просмотров" → WHERE views_count > N
"Рост за период" → SUM(delta_views_count) из video_snapshots
"Сколько разных видео получали новые просмотры" →
COUNT(DISTINCT video_id)
WHERE delta_views_count > 0

Если говорится о росте за дату или период — использовать таблицу video_snapshots.
Если говорится о текущем количестве просмотров — использовать videos.views_count.
Работа с датами
Все даты в UTC.

Дата без времени означает:
= YYYY-MM-DD 00:00:00
AND
<= YYYY-MM-DD 23:59:59

Период "с X по Y включительно":
= X 00:00:00
AND
<= Y 23:59:59

Таблицы

videos(
...
)

video_snapshots(
...
)


Используется корректный синтаксис PostgreSQL.
Если есть ошибка — исправь и выведи корректный SQL.

ЗАПРОС ПОЛЬЗОВАТЕЛЯ:
```


---


## ⚙ Технологии

- Python 3.12
- PostgreSQL 16
- Docker Compose
- psycopg
- aiogram 
- gigachat

---