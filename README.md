# DB ACCESS MODULE

Телеграм бот для получения данных из бд по запросу на естественном языке.

---

## Установка и запуск

### 1. Клонировать репозиторий

```bash
git clone git@github.com:whosermak/tg_bot.git
cd tg_bot
```

### 2. Создать файл окружения

```bash
cp .env_example .env
```

Заполнить значения в `.env`!!!!!

### 3. Запустить проект

```bash
docker compose up --build
```

После запуска:
- поднимается бд на postgres
- импортируются данные (дождитесь завершения пж)
- запускается тг бот

бот начинает принимать сообщения.

---

## Получение чувствительных данных

### Telegram Bot Token

1. Найти бота **BotFather** в тг
2. Выполнить команду `/newbot`
3. Получить токен и вставить его в `.env`

```
BOT_TOKEN=токен
```

---

### Ключ для GigaChat

1. Зарегистрироваться на https://developers.sber.ru/
2. Получить api ключ для gigachat
3. Добавить в `.env`

```
GIGACHAT_API_KEY=токен
```

---


## Архитектура проекта

Проект состоит из трёх сервисов:

- **db** — PostgreSQL
- **import** — импорт данных в бд
- **bot** — запуск бота

### обработка запроса:

1. Пользователь отправляет текстовое сообщение боту.
2. Запрос преобразуется в sql с помощью gigachat.
3. sql выполняется в postgres и результат отправляется пользователю.

---

## Подход к преобразованию текста в sql

1. В промпт передаётся описание таблиц
2. Пользовательский запрос добавляется в конце промта
3. Модель генерирует sql
5. Sql ыполняется в базе данных

### Пример промта

```
Ты генерируешь SQL для PostgreSQL.
На входе — вопрос на русском.
На выходе — ОДИН SQL-запрос, возвращающий ОДНО число.

Правила:
Только SQL.
Без комментариев.
Без пояснений.
Без markdown.
Используй только таблицы и поля ниже.
Если результат может быть NULL — используй COALESCE(..., 0).

Таблицы

videos(
...
)

video_snapshots(
...
)

Логика:

Общее количество видео → videos
Текущие просмотры → videos.views_count
Рост за период → SUM(delta_views_count) из video_snapshots
Количество видео с ростом → COUNT(DISTINCT video_id) где delta_views_count > 0
Даты без времени = границы суток UTC
Период "с X по Y включительно" = >= X 00:00:00 и <= Y 23:59:59
Всегда возвращай ровно одну строку и один столбец.

ПОМНИ: это PostgreSQL, пиши sql по правилам postgres

ЗАПРОС ПОЛЬЗОВАТЕЛЯ: 
```


---


## ⚙ Технологии

- Python 3.12
- PostgreSQL 16
- Docker Compose
- psycopg
- aiogram 
- gigachat

---